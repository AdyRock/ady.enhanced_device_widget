<html>

<head>
	<link rel="stylesheet" type="text/css" href="extraStyles.css">
</head>

<body class="homey-widget">
	<div class="container">
		<img id="deviceIcon" src="homey-logo.png" alt="Device Icon" class="device-image-class" />
		<div id="deviceName" class="homey-text-bold">Device.</div>
	</div>
	<hr>
	<div id="capabilitiesSection"></div>

	<script type="text/javascript">
		var SliderCancelTimer = null;
		var oldValue = null;

		function onHomeyReady(Homey)
		{
			const widgetId = Homey.getWidgetInstanceId();


			// View the settings the user provided if your widget has settings.
			const settings = Homey.getSettings();
			document.getElementById('deviceName').innerHTML = settings.devices.name;
			document.getElementById('deviceIcon').src = settings.devices.iconObj.url;

			// Homey.api('GET', `/?deviceImage=${settings.devices.id}`, {})
			// 	.then((result) =>
			// 	{
			// 		document.getElementById('deviceIcon').src = result;
			// 	})
			// 	.catch(console.error);

			updateValues(true);

			Homey.ready();

			Homey.on('updateWidget', function ({ deviceId, capabilityID, value })
			{
				const settings = Homey.getSettings();
				if (settings.devices.id === deviceId)
				{
					if (typeof (value) === 'number')
					{
						const slider = document.getElementById(`${capabilityID}_slide`);
						if (slider)
						{
							slider.value = value;
						}
						if ((capabilityID === 'dim') || (capabilityID === 'windowcoverings_set'))
						{
							value = value * 100;
							value = value.toFixed();
						}
						document.getElementById(`${capabilityID}`).innerHTML = `${value}`;
					}
					else if (typeof (value) === 'boolean')
					{
						document.getElementById(`${capabilityID}`).checked = value;
					}
					else
					{
						document.getElementById(`${capabilityID}`).innerHTML = value;
					}
				}
			});

			function updateValues(register)
			{
				const widgetId = Homey.getWidgetInstanceId();

				// View the settings the user provided if your widget has settings.
				const settings = Homey.getSettings();

				// Fetch something from your app.
				Homey.api('GET', `/?deviceId=${settings.devices.id}&register=${register}`, {})
					.then((result) =>
					{
						var html = '';
						var height = 300;
						if (result)
						{
							// Add each of the capabilities to the panel
							const capabilitiesArray = Object.values(result);
							height = ((capabilitiesArray.length) * 29) + 78;
							for (const capability of capabilitiesArray)
							{
								// create an HTML line for each capability with the title left aligned and the value right aligned
								if (capability.setable === true)
								{
									if ((capability.type === "boolean") && capability.getable)
									{
										// create a switch for boolean capabilities
										html += `<div>
													<p class="alignleft homey-font-size-default" style="padding-top:6px; padding-bottom:5px"> ${capability.title}</p>
													<p class="alignright homey-font-size-default" style="padding-top:6px; padding-bottom:5px">
														<b>
															<span>
																<label class="switch">
																	<input id="${capability.id}" type="checkbox" ${capability.value ? 'checked' : ''} onclick="onOffToggle('${settings.devices.id}', '${capability.id}')">
																	<span class="slider round">
																	</span>
																</label>
															</span>
														</b>
													</p>
												</div>
												<div style="clear: both;">
												</div>`;
									}
									else if (capability.type === "boolean")
									{
										// Create a push button
										html += `<div>
													<p class="alignleft homey-font-size-default" style="padding-top:6px; padding-bottom:5px"> ${capability.title}</p>
													<p class="alignright homey-font-size-default" style="padding-top:6px; padding-bottom:5px">
														<b>
															<span>
																<button class="button" id="${capability.id}" onclick="buttonPressed('${settings.devices.id}', '${capability.id}')">
																	1
																</button>
															</span>
														</b>
													</p>
												</div>
												<div style="clear: both;">
												</div>`;
									}
									else if (capability.type === "number")
									{
										// Allow extra space for sliders
										height += 30;

										// create a slider for number capabilities
										html += `<div>
													<p class="alignleft homey-font-size-default" style="padding-top:6px; padding-bottom:1px"> ${capability.title}</p><p class="alignright homey-font-size-default" style="padding-top:6px; padding-bottom:5px"><b> <span id="${capability.id}">${(capability.id === 'dim') || (capability.id == 'windowcoverings_set') ? capability.value * 100 : capability.value}</span> </b> ${capability.units ? capability.units : ''}</p>
												</div>
												<div style="clear: both;"></div>
												<p class="homey-font-size-default" style="padding-top:0px; padding-bottom:5px">
												<input
													id="${capability.id}_slide"
													type="range"
													min="${capability.min}"
													max="${capability.max}"
													step="${(capability.max - capability.min) / 100}"
													value="${capability.value}"
													onchange="numberChange('${settings.devices.id}', '${capability.id}')"
													oninput="numberSlide('${capability.id}')"
													onpointerdown="handlePointerDown(event)"
													onpointerup="handlePointerUp(event)"
													onpointermove="handlePointerMove(event)"
													ontouchstart="handleTouchStart(event)"
													ontouchmove="handleTouchStart(event)"
													onfocus="handleCancelFocus(event)">
												</p>
												<div style="clear: both;"></div>`;
									}
									else
									{
										html += `<div><p class="alignleft homey-font-size-default" style="padding-top:6px; padding-bottom:5px"> ${capability.title}</p> <p class="alignright homey-font-size-default" style="padding-top:5px; padding-bottom:5px"><b> <span id="${capability.id}"> ${capability.value}</span> </b> ${capability.units ? capability.units : ''}</p> </div> <div style="clear: both;"></div>`;
									}
								}
								else
								{
									html += `<div><p class="alignleft homey-font-size-default" style="padding-top:6px; padding-bottom:5px"> ${capability.title}</p> <p class="alignright homey-font-size-default" style="padding-top:5px; padding-bottom:5px"><b> <span id="${capability.id}"> ${capability.value}</span> </b> ${capability.units ? capability.units : ''}</p> </div> <div style="clear: both;"></div>`;
								}
							}
						}

						document.getElementById('capabilitiesSection').innerHTML = html;
						Homey.setHeight(height);

						console.log(result);
						return;
					})
					.catch(console.error);
			}
		}

		function onOffToggle(deviceId, capabilityId)
		{
			const element = document.getElementById(capabilityId);
			const value = element.checked;

			Homey.api('POST', '/', { deviceId: deviceId, capabilityId: capabilityId, value: value })
				.then((result) =>
				{
					console.log(result);
					return;
				})
				.catch(console.error);
		}

		function buttonPressed(deviceId, capabilityId)
		{
			const element = document.getElementById(capabilityId);

			Homey.api('POST', '/', { deviceId: deviceId, capabilityId: capabilityId, value: true })
				.then((result) =>
				{
					console.log(result);
					return;
				})
				.catch(console.error);
		}

		function numberChange(deviceId, capabilityId)
		{
			const element = document.getElementById(`${capabilityId}_slide`);
			const value = parseFloat(element.value);
			clearTimeout(SliderCancelTimer);
			oldValue = null;

			Homey.api('POST', '/', { deviceId: deviceId, capabilityId: capabilityId, value: value })
				.then((result) =>
				{
					console.log(result);
					return;
				})
				.catch(console.error);
		}

		function numberSlide(capabilityId)
		{
			const element = document.getElementById(`${capabilityId}_slide`);
			let value = parseFloat(element.value);

			if (oldValue === null)
			{
				oldValue = document.getElementById(capabilityId).innerHTML;
			}

			if ((capabilityId === 'dim') || (capabilityId === 'windowcoverings_set'))
			{
				value = (value * 100);
				value = value.toFixed();
			}

			document.getElementById(capabilityId).innerHTML = `${value}`;

			clearTimeout(SliderCancelTimer);
			SliderCancelTimer = setTimeout(() =>
			{
				// reset slider position to current value if the slider was moved but then cancled due to finger sliding
				document.getElementById(capabilityId).innerHTML = `${oldValue}`;

				if ((capabilityId === 'dim') || (capabilityId === 'windowcoverings_set'))
				{
					oldValue = (oldValue / 100);
				}
				element.value = oldValue;

				oldValue = null;
			}, 500);
		}

		function handleCancelFocus(event)
		{
			// event.stopPropagation();
			// event.preventDefault();
		}

		function handleTouchStart(event)
		{
			event.stopPropagation(); // Prevent the default behavior of the touch start event
			event.stopImmediatePropagation();
		}

		// Function to handle pointer down and capture the pointer
		function handlePointerDown(event)
		{
			event.stopPropagation(); // Prevent the default behavior of the pointer down event
			event.target.setPointerCapture(event.pointerId); // Capture the pointer to prevent losing focus
		}

		// Function to handle pointer down and capture the pointer
		function handlePointerMove(event)
		{
			event.stopPropagation(); // Prevent the default behavior of the pointer down event
			event.stopImmediatePropagation();
		}

		// Function to handle pointer up and release the pointer capture
		function handlePointerUp(event)
		{
			event.target.releasePointerCapture(event.pointerId); // Release the pointer after interaction ends
		}

	</script>
</body>

</html>